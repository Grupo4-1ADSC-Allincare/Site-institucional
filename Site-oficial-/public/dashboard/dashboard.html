<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DashBoard | Allincare</title>
  <link rel="stylesheet" type="text/css" href="dashboards.css" />

  <script type="text/javascript" src="https://www.chartjs.org/dist/2.8.0/Chart.min.js"></script>

</head>

<body>
  <div class="container">
    <div class="navigation">
      <ul>
        <li>
          <a href="#">
            <span class="icon">
              <ion-icon name="medkit-outline"></ion-icon>
            </span>
            <span class="title">Bem-vindo!</span>
          </a>
        </li>
        <li>
          <a href="#">
            <span class="icon">
              <ion-icon name="home-outline"></ion-icon>
            </span>
            <span class="title">DashBoard</span>
          </a>
        </li>

        <!-- <li>
            <a href="#">
              <span class="icon"
                ><ion-icon name="bar-chart-outline"></ion-icon
              ></span>
              <span class="title">Gráfico</span>
            </a>
          </li> -->
        <li>
          <a href="#">
            <span class="icon">
              <ion-icon name="chatbubble-outline"></ion-icon>
            </span>
            <span class="title">Mensagem</span>
          </a>
        </li>
        <li>
          <a href="../login.html">
            <span class="icon">
              <ion-icon name="log-out-outline"></ion-icon>
            </span>
            <span class="title">Logout</span>
          </a>
        </li>
      </ul>
    </div>

    <!--Principal-->
    <div class="main">
      <div class="topbar">
        <div class="toggle">
          <ion-icon name="menu-outline"></ion-icon>
        </div>

        <!-- Search
          <div class="search">
            <label>
              <input type="text" placeholder="Search here" />
              <ion-icon name="search-outline"></ion-icon>
            </label>
          </div>-->

        <div class="search">
          <div class="title">
            <h3>Olá, <span id="b_usuario">usuário</span>!</h3>
          </div>
        </div>

        <!-- UserImage-->
        <div class="user">
          <ion-icon class="icone" name="person-circle-outline"></ion-icon>
        </div>
      </div>

      <!--KPis-->
      <div class="cardBox">
        <div class="card">
          <div>
            <div class="numbers">-22,5°C</div>
            <div class="cardName">Crítico frio</div>
          </div>
          <div class="iconbx">
            <ion-icon name="thermometer-outline"></ion-icon>
          </div>
        </div>

        <div class="card">
          <div>
            <div class="numbers">-21,5°C</div>
            <div class="cardName">Alerta frio</div>
          </div>
          <div class="iconbx">
            <ion-icon name="thermometer-outline"></ion-icon>
          </div>
        </div>

        <div class="card">
          <div>
            <div class="numbers">-20°C</div>
            <div class="cardName">Ideal</div>
          </div>
          <div class="iconbx">
            <ion-icon name="thermometer-outline"></ion-icon>
          </div>
        </div>

        <div class="card">
          <div>
            <div class="numbers">-18,5°C</div>
            <div class="cardName">Alerta quente</div>
          </div>
          <div class="iconbx">
            <ion-icon name="thermometer-outline"></ion-icon>
          </div>
        </div>

        <div class="card">
          <div>
            <div class="numbers">-17,5°C</div>
            <div class="cardName">Crítico quente</div>
          </div>
          <div class="iconbx">
            <ion-icon name="thermometer-outline"></ion-icon>
          </div>
        </div>
      </div>

      <div class="details">
        <!-- Tela de detalhes-->
        <div class="ordersTemp">
          <div class="cardHeader">
            <h2>Caminhões Ativos</h2>
            <a href="#" class="btn">Ver tudo</a>
          </div>
          <table>
            <thead>
              <tr>
                <td>Modelo caminhão</td>
                <td>Id</td>
                <td>Temperatura</td>
                <td>Status</td>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>
                  <a onclick="abrir_model()" class="btn-model">Volks - 8150</a>
                </td>
                <td>01</td>
                <td>-18°C</td>
                <td>
                  <span class="status alerta-quente">Alerta quente</span>
                </td>
              </tr>
              <tr>
                <td>Mercedes - 710</td>
                <td>02</td>
                <td>-22,9°C</td>
                <td><span class="status critico-frio">Crítico frio</span></td>
              </tr>
              <tr>
                <td>Volks - 9150</td>
                <td>03</td>
                <td>-21,9°C</td>
                <td><span class="status alerta-frio">Alerta frio</span></td>
              </tr>
              <tr>
                <td>Volks - 13180</td>
                <td>04</td>
                <td>-19,9°C</td>
                <td><span class="status ideal">Ideal</span></td>
              </tr>
              <tr>
                <td>Volvo - FH 460</td>
                <td>05</td>
                <td>-17,9°C</td>
                <td>
                  <span class="status alerta-quente">Alerta quente</span>
                </td>
              </tr>
              <tr>
                <td>Mercedes - Atego 2425</td>
                <td>06</td>
                <td>-23,1°C</td>
                <td><span class="status critico-frio">Crítico frio</span></td>
              </tr>
              <tr>
                <td>Mercedes - Accelo 815</td>
                <td>07</td>
                <td>-22,1°C</td>
                <td><span class="status alerta-frio">Alerta frio</span></td>
              </tr>
              <tr>
                <td>Volvo - 260</td>
                <td>08</td>
                <td>-18,4°C</td>
                <td>
                  <span class="status alerta-quente">Alerta quente</span>
                </td>
              </tr>
              <tr>
                <td>Scania - R440</td>
                <td>09</td>
                <td>-18,2°C</td>
                <td>
                  <span class="status alerta-quente">Alerta quente</span>
                </td>
              </tr>
              <tr>
                <td>Volks - 13180</td>
                <td>10</td>
                <td>-21,7°C</td>
                <td><span class="status alerta-frio">Alerta frio</span></td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- detalhe top 10-->
        <div class="recentTemp">
          <div class="cardHeader">
            <h2>Caminhões desregulados</h2>
          </div>
          <table>
            <tr>
              <td width="60px">
                <div class="imgBx">
                  <ion-icon class="ion" name="bus-outline"></ion-icon>
                </div>
              </td>

              <td>
                <h4>
                  Id:06<br /><span class="critico-frio">Crítico frio</span>
                </h4>
              </td>
              <td>Caminhão em estado crítico frio, faça algo imediatamente.</td>
            </tr>
            <tr>
              <td width="60px">
                <div class="imgBx">
                  <ion-icon class="ion" name="bus-outline"></ion-icon>
                </div>
              </td>
              <td>
                <h4>
                  Id:03<br /><span class="critico-frio">Crítico frio</span>
                </h4>
              </td>
              <td>Caminhão em estado crítico frio, faça algo imediatamente!</td>
            </tr>
            <tr>
              <td width="60px">
                <div class="imgBx">
                  <ion-icon class="ion" name="bus-outline"></ion-icon>
                </div>
              </td>
              <td>
                <h4>
                  Id:07<br /><span class="alerta-frio">Alerta frio</span>
                </h4>
              </td>
              <td>Caminhão em estado de alerta frio, faça algo imediatamente!</td>
            </tr>
            <tr>
              <td width="60px">
                <div class="imgBx">
                  <ion-icon class="ion" name="bus-outline"></ion-icon>
                </div>
              </td>
              <td>
                <h4>
                  Id:04<br /><span class="alerta-frio">Alerta frio</span>
                </h4>
              </td>
              <td>Caminhão em estado de alerta frio, faça algo imediatamente!</td>
            </tr>
            <tr>
              <td width="60px">
                <div class="imgBx">
                  <ion-icon class="ion" name="bus-outline"></ion-icon>
                </div>
              </td>
              <td>
                <h4>
                  Id:10<br /><span class="alerta-frio">Alerta frio</span>
                </h4>
              </td>
              <td>Caminhão em estado de alerta frio, faça algo imediatamente!</td>
            </tr>
            <tr>
              <td width="60px">
                <div class="imgBx">
                  <ion-icon class="ion" name="bus-outline"></ion-icon>
                </div>
              </td>
              <td>
                <h4>
                  Id:05<br /><span class="alerta-quente">Alerta quente</span>
                </h4>
              </td>
              <td>Caminhão em estado de alerta quente, faça algo imediatamente!</td>
            </tr>
            <tr>
              <td width="60px">
                <div class="imgBx">
                  <ion-icon class="ion" name="bus-outline"></ion-icon>
                </div>
              </td>
              <td>
                <h4>
                  Id:02<br /><span class="alerta-quente">Alerta quente</span>
                </h4>
              </td>
              <td>Caminhão em estado de alerta quente, faça algo imediatamente!</td>
            </tr>
            <tr>
              <td width="60px">
                <div class="imgBx">
                  <ion-icon class="ion" name="bus-outline"></ion-icon>
                </div>
              </td>
              <td>
                <h4>
                  Id:09<br /><span class="alerta-quente">Alerta quente</span>
                </h4>
              </td>
              <td>Caminhão em estado de alerta quente, faça algo imediatamente!</td>
            </tr>
          </table>
        </div>

        <div class="modal-container">
          <div class="modal">
            <h1 class="title">Caminhão Id: 01 - Volks - 8150</h1>
            <span id="mensagem_usuario"></span>
            <div class="graphBox">
              <div class="box"><canvas id="myChart2"></canvas></div>
            </div>

            <button onclick="fechar_model()" class="btn">Fechar</button>
          </div>
        </div>

        <!-- <div class="cardAlert">
          <div class="card">
            <div>
              <div class="numbers">-24,2°C</div>
              <div class="cardName">idCaminhão: 01</div>
            </div>
            <div class="iconbx">
              <ion-icon name="car-outline"></ion-icon>
            </div>
          </div>

          <div class="card">
            <div>
              <div class="numbers">-22,6°C</div>
              <div class="cardName">idCaminhão: 02</div>
            </div>
            <div class="iconbx">
              <ion-icon name="car-outline"></ion-icon>
            </div>
          </div>

          <div class="card">
            <div>
              <div class="numbers">-21,1°C</div>
              <div class="cardName">idCaminhão: 03</div>
            </div>
            <div class="iconbx">
              <ion-icon name="car-outline"></ion-icon>
            </div>
          </div>

          <div class="card">
            <div>
              <div class="numbers">-18,4°C</div>
              <div class="cardName">idCaminhão: 04</div>
            </div>
            <div class="iconbx">
              <ion-icon name="car-outline"></ion-icon>
            </div>
          </div>
          -->
      </div>
    </div>
  </div>
  <script src=""></script>
  <!-- <script src="public/js/my_chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script> -->
  <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>

  <script>
    // menuToggle
    let toggle = document.querySelector('.toggle')
    let navigation = document.querySelector('.navigation')
    let main = document.querySelector('.main')

    toggle.onclick = function () {
      navigation.classList.toggle('active')
      main.classList.toggle('active')
    }
    //add class in selected list item
    let list = document.querySelectorAll('.navigation li')
    function activeLink() {
      list.forEach((item) => item.classList.remove('hovered'))
      this.classList.add('hovered')
    }
    list.forEach((item) => item.addEventListener('mouseover', activeLink))
  </script>
</body>
<script>

  let proximaAtualizacao;

  window.onload = obterDadosGrafico(1);

  b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

  function alterarTitulo(idVeiculo) {
    var tituloVeiculo = document.getElementById("tituloVeiculo")
    mensagem_usuario.innerHTML = "Últimas medidas de Temperatura do <span style='color: #e6005a'>Veículo " + idVeiculo + "</span>"
  }

  // O gráfico é construído com três funções:
  // 1. obterDadosGrafico -> Traz dados do Banco de Dados para montar o gráfico da primeira vez
  // 2. plotarGrafico -> Monta o gráfico com os dados trazidos e exibe em tela
  // 3. atualizarGrafico -> Atualiza o gráfico, trazendo novamente dados do Banco

  // Esta função *obterDadosGrafico* busca os últimos dados inseridos em tabela de medidas.
  // para, quando carregar o gráfico da primeira vez, já trazer com vários dados.
  // A função *obterDadosGrafico* também invoca a função *plotarGrafico*

  //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
  //     Para ajustar o "select", ajuste o comando sql em src/models
  function obterDadosGrafico(idVeiculo) {
    alterarTitulo(idVeiculo)

    if (proximaAtualizacao != undefined) {
      clearTimeout(proximaAtualizacao);
    }

    fetch(`/medidas/ultimas/${idVeiculo}`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {
          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
          resposta.reverse();

          plotarGrafico(resposta, idVeiculo);
        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }

  // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
  // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
  // A função *plotarGrafico* também invoca a função *atualizarGrafico*
  function plotarGrafico(resposta, idVeiculo) {
    console.log('Iniciando plotagem do gráfico...');

    var dados = {
      labels: [],
      datasets: [
        {
          yAxisID: 'y-temperatura',
          label: 'Temperatura',
          borderColor: '#FFF',
          backgroundColor: '#32b9cd8f',
          fill: true,
          data: []
        }
      ]
    };

    for (i = 0; i < resposta.length; i++) {
      var registro = resposta[i];
      dados.labels.push(registro.momento_grafico);
      dados.datasets[0].data.push(registro.temperatura);
    }

    console.log(JSON.stringify(dados));

    const ctx2 = document.getElementById('myChart2').getContext('2d')
    window.myChart2 = Chart.Line(ctx2, {
      type: 'line',
      data: dados,
      options: {
        responsive: true,
        animation: { duration: 500 },
        hoverMode: 'index',
        stacked: false,
        title: {
          display: false,
          text: 'Dados capturados'
        },
        scales: {
          yAxes: [{
            type: 'linear',
            display: true,
            position: 'left',
            id: 'y-temperatura',
            ticks: {
              beginAtZero: true,
              max: 100,
              min: 0
            }
          },],
        }
      }
    });

    setTimeout(() => atualizarGrafico(idVeiculo, dados), 1000);
  }


  // Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página,
  // buscando a última medida inserida em tabela contendo as capturas, 

  //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
  //     Para ajustar o "select", ajuste o comando sql em src/models
  function atualizarGrafico(idVeiculo, dados) {
    fetch(`/medidas/tempo-real/${idVeiculo}`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (novoRegistro) {

          console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
          console.log(`Dados atuais do gráfico: ${dados}`);

          // tirando e colocando valores no gráfico
          dados.labels.shift(); // apagar o primeiro
          dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento

          dados.datasets[0].data.shift();  // apagar o primeiro de temperatura
          dados.datasets[0].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura

          window.myChart2.update();

          // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
          proximaAtualizacao = setTimeout(() => atualizarGrafico(idVeiculo, dados), 1000);
        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
        // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
        proximaAtualizacao = setTimeout(() => atualizarGrafico(idVeiculo, dados), 1000);
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });

  }
</script>

<script>
  const modal = document.querySelector('.modal-container')
  function abrir_model() {
    obterDadosGrafico(1)
    modal.classList.add('abre')
  }

  function fechar_model() {
    modal.classList.remove('abre')
  }
</script>

</html>